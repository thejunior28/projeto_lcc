<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel do Emissor | Let's CoCreate</title>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      :root {
        --primary: #22d3ee;
        --dark: #000000;
        --card-bg: #111111;
        --border: #333333;
        --text: #f8fafc;
        --danger: #ef4444;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--dark);
        color: var(--text);
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .dashboard {
        background: var(--card-bg);
        width: 100%;
        max-width: 480px;
        padding: 35px;
        border-radius: 24px;
        box-shadow: 0 0 40px rgba(34, 211, 238, 0.1);
        border: 1px solid var(--border);
      }
      .brand { text-align: center; margin-bottom: 25px; }
      .brand-logo { width: 100px; height: auto; margin-bottom: 8px; border-radius: 12px; }
      .brand span { font-size: 11px; text-transform: uppercase; letter-spacing: 3px; color: #94a3b8; display: block; font-weight: 600; }
      .wallet-control { margin-bottom: 30px; display: flex; justify-content: center; }
      .input-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #cbd5e1; }
      input[type="text"], input[type="number"] { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: white; border-radius: 10px; box-sizing: border-box; font-size: 14px; outline: none; transition: 0.3s; }
      input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2); }
      
      .upload-zone { border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.02); position: relative; overflow: hidden; }
      .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(34, 211, 238, 0.05); }
      .upload-icon { font-size: 24px; color: var(--primary); margin-bottom: 10px; }
      .upload-text { font-size: 12px; color: #94a3b8; }
      .preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; display: none; margin-top: 10px; border: 1px solid var(--border); }

      button { width: 100%; padding: 14px; background: var(--primary); color: black; border: none; border-radius: 10px; font-size: 15px; font-weight: 800; cursor: pointer; transition: transform 0.2s; margin-top: 10px; }
      button:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); }
      .btn-link { display: block; text-align: center; margin-top: 20px; padding: 12px; border: 1px solid var(--border); border-radius: 10px; color: var(--text); text-decoration: none; font-size: 13px; transition: 0.3s; background: rgba(255, 255, 255, 0.03); }
      .btn-link:hover { border-color: var(--primary); color: var(--primary); }
      .footer-note { margin-top: 25px; text-align: center; font-size: 11px; color: #475569; }
      .footer-note a { color: #64748b; text-decoration: none; }
      
      /* REVOGA√á√ÉO (Escondido por padr√£o) */
      details { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 15px; }
      summary { color: var(--danger); font-size: 12px; cursor: pointer; font-weight: bold; text-align: center; list-style: none; }
      .btn-revoke { background: transparent; border: 1px solid var(--danger); color: var(--danger); box-shadow: none; margin-top: 10px; }
      .btn-revoke:hover { background: var(--danger); color: white; }
      
      #welcomeMsg { text-align: center; color: #94a3b8; font-size: 14px; margin-top: 20px; }
      w3m-button { display: block; margin: 0 auto; }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="brand">
        <img id="brandLogoImg" class="brand-logo" src="" alt="" crossorigin="anonymous" />
        <span> SciBound | Soulbound Tokens </span>
      </div>

      <div class="wallet-control">
        <w3m-button label="üîå Conectar Carteira" balance="show"></w3m-button>
      </div>

      <div id="welcomeMsg">üëÜ Conecte sua carteira para acessar o painel.</div>

      <div id="mainArea" style="display: none">
        
        <div class="input-group">
          <label>Imagem do Certificado</label>
          <div class="upload-zone" id="dropZone">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <div class="upload-text">Clique ou Arraste o arquivo aqui</div>
            <input type="file" id="fileInput" accept="image/*" hidden />
            <img id="imagePreview" class="preview-img" />
          </div>
        </div>

        <div class="input-group">
          <label>Nome do Aluno</label>
          <input type="text" id="nomeAluno" placeholder="Ex: Ana Silva" />
        </div>
        <div class="input-group">
          <label>Curso</label>
          <input type="text" id="nomeCurso" placeholder="Ex: Blockchain Specialist" />
        </div>
        <div class="input-group">
          <label>Data de Conclus√£o</label>
          <input type="text" id="dataColacao" placeholder="Ex: 18 de dezembro de 2025" />
        </div>
        <div class="input-group">
          <label>Carteira do aluno (0x...)</label>
          <input type="text" id="walletAluno" placeholder="Endere√ßo p√∫blico" />
        </div>

        <div class="input-group">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <label>C√≥digo de Valida√ß√£o</label>
            <span onclick="gerarCodigoAleatorio()" style="font-size: 11px; color: var(--primary); cursor: pointer; text-decoration: underline;">üîÑ Gerar Aleat√≥rio</span>
          </div>
          <input type="text" id="codigoValidacao" placeholder="Ex: RA-2026-B" />
          <p style="font-size: 11px; color: #64748b; margin: 5px 0 0 0; line-height: 1.4;">
            ‚ÑπÔ∏è Identificador √∫nico (Ex: Matr√≠cula). <strong>N√£o use c√≥digos repetidos.</strong>
          </p>
        </div>

        <button onclick="emitirDiploma()">‚ú® Registrar na Blockchain</button>

        <details id="areaRevogacao" style="display: none;">
          <summary>‚ö†Ô∏è Painel Administrativo (Revoga√ß√£o)</summary>
          <div style="margin-top: 10px">
            <input type="number" id="idRevogar" placeholder="ID do Token (Ex: 5)" style="margin-bottom: 5px" />
            <input type="text" id="motivoRevogar" placeholder="Motivo da revoga√ß√£o" />
            <button class="btn-revoke" onclick="revogarDiploma()">Revogar Permanentemente</button>
          </div>
        </details>
      </div>

      <a href="verificar.html" target="_blank" class="btn-link">üîç Verificador de Certificados</a>

      <div class="footer-note">Tecnologia Let's CoCreate</div>
    </div>

    <script type="module">
      import { createWeb3Modal, defaultConfig } from "https://esm.sh/@web3modal/ethers@4.0.1";
      import { BrowserProvider, Contract } from "https://esm.sh/ethers@6.11.1";

      const LOGO_URL = "https://salmon-blank-anaconda-377.mypinata.cloud/ipfs/bafkreibzuryiyn54v4ji6gtfzo3grpz3rzgrwa5cqbysujssv5gp5q4gxi";
      const contractAddress = "0x35670719542F0430cB8d9abbcE97fAc1FcfebE09"; 
      const LINK_VERIFICADOR = "https://scibound.netlify.app/verificar.html";
      const projectId = "ccaa314f20e97669bf6e926f17670656";

      const metadata = { name: "Emissor", description: "Painel", url: window.location.origin, icons: [LOGO_URL] };
      const baseMainnet = { chainId: 8453, name: "Base", currency: "ETH", explorerUrl: "https://basescan.org", rpcUrl: "https://mainnet.base.org" };

      document.getElementById("brandLogoImg").src = LOGO_URL;
      
      function notify(msg, type) {
        Toastify({ text: msg, duration: 4000, gravity: "top", position: "center", style: { background: type === "success" ? "#10B981" : type === "error" ? "#EF4444" : "#3B82F6", borderRadius: "10px" } }).showToast();
      }

      window.gerarCodigoAleatorio = function() {
        document.getElementById("codigoValidacao").value = "LCC-" + Math.random().toString(36).substr(2, 9).toUpperCase();
        if(document.getElementById("mainArea").style.display === "block") notify("Novo c√≥digo gerado!", "success");
      }
      window.gerarCodigoAleatorio();

      const modal = createWeb3Modal({ ethersConfig: defaultConfig({ metadata }), chains: [baseMainnet], projectId, themeVariables: { "--w3m-accent": "#22d3ee", "--w3m-border-radius-master": "1px" } });

      // === ATUALIZADO: ABI COM FUN√á√ÉO OWNER ===
      const abi = [
        "function emitirCertificado(address aluno, string memory uri) public",
        "function revogarCertificado(uint256 tokenId) public",
        "function owner() view returns (address)" // Necess√°rio para verificar dono
      ];

      // === ATUALIZADO: L√ìGICA DE VERIFICA√á√ÉO DE DONO ===
      modal.subscribeProvider(async ({ address, isConnected }) => {
        if (isConnected) {
          document.getElementById("mainArea").style.display = "block";
          document.getElementById("welcomeMsg").style.display = "none";
          notify("‚úÖ Carteira Conectada", "success");

          // Verifica se √© o dono para liberar a revoga√ß√£o
          try {
            const provider = new BrowserProvider(modal.getWalletProvider());
            const contract = new Contract(contractAddress, abi, provider);
            
            // Pega o dono do contrato na Blockchain
            const ownerAddress = await contract.owner();
            
            // Compara (tudo min√∫sculo para garantir)
            if (address.toLowerCase() === ownerAddress.toLowerCase()) {
                document.getElementById("areaRevogacao").style.display = "block";
                console.log("Modo Admin: Ativado");
            } else {
                document.getElementById("areaRevogacao").style.display = "none";
                console.log("Modo Admin: Bloqueado (Voc√™ n√£o √© o dono)");
            }
          } catch (e) {
            console.error("Erro ao verificar admin:", e);
          }

        } else {
          document.getElementById("mainArea").style.display = "none";
          document.getElementById("welcomeMsg").style.display = "block";
        }
      });

      // L√≥gica de Upload
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');
      let currentFileBase64 = null;

      dropZone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });

      function handleFile(file) {
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => { currentFileBase64 = e.target.result; imagePreview.src = currentFileBase64; imagePreview.style.display = 'block'; document.querySelector('.upload-text').innerText = file.name; };
          reader.readAsDataURL(file);
        } else { notify("Imagem inv√°lida.", "error"); }
      }

      async function getSigner() {
        const walletProvider = modal.getWalletProvider();
        if (!walletProvider) throw new Error("Conecte novamente.");
        const provider = new BrowserProvider(walletProvider);
        return await provider.getSigner();
      }

      async function emitirDiploma() {
        if (!currentFileBase64) return notify("‚ö†Ô∏è Fa√ßa o upload da imagem!", "error");
        const nome = document.getElementById("nomeAluno").value;
        const curso = document.getElementById("nomeCurso").value;
        const data = document.getElementById("dataColacao").value;
        const wallet = document.getElementById("walletAluno").value;
        const codigo = document.getElementById("codigoValidacao").value;

        if (!nome || !wallet || !codigo) return notify("Preencha todos os campos.", "error");

        try {
          notify("‚è≥ Subindo imagem...", "loading");
          const imgRes = await fetch("/.netlify/functions/upload-img", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ imageBase64: currentFileBase64, name: `Img_${codigo}` }) });
          if (!imgRes.ok) throw new Error((await imgRes.json()).error || "Erro imagem");
          const ipfsImageLink = "https://gateway.pinata.cloud/ipfs/" + (await imgRes.json()).IpfsHash;

          notify("‚è≥ Gerando metadados...", "loading");
          const signer = await getSigner();
          const contract = new Contract(contractAddress, abi, signer);

          const metadata = {
            name: `Certificado Let's CoCreate - ${nome}`,
            description: "Certificado Soulbound Token.",
            image: ipfsImageLink,
            external_url: LINK_VERIFICADOR,
            attributes: [
              { trait_type: "Institui√ß√£o", value: "Let's CoCreate" },
              { trait_type: "Estudante", value: nome },
              { trait_type: "Curso", value: curso },
              { trait_type: "Data de Conclus√£o", value: data },
              { trait_type: "C√≥digo de Valida√ß√£o", value: codigo },
            ],
          };

          const metaRes = await fetch("/.netlify/functions/upload", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ pinataContent: metadata, pinataMetadata: { name: `Cert_${codigo}.json` } }) });
          if (!metaRes.ok) throw new Error("Erro metadados");
          const jsonUri = "ipfs://" + (await metaRes.json()).IpfsHash;

          notify("‚è≥ Aprove na Carteira...", "loading");
          const tx = await contract.emitirCertificado(wallet, jsonUri);
          notify("‚è≥ Confirmando...", "loading");
          await tx.wait();

          notify(`üéâ Sucesso! Hash: ${tx.hash.slice(0, 6)}...`, "success");
          confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          
          window.gerarCodigoAleatorio();
          document.getElementById("imagePreview").style.display = "none";
          document.querySelector('.upload-text').innerText = "Clique ou Arraste o arquivo aqui";
          currentFileBase64 = null;
        } catch (e) { console.error(e); notify(e.reason || e.message || "Erro desconhecido", "error"); }
      }

      async function revogarDiploma() {
        const id = document.getElementById("idRevogar").value;
        const motivo = document.getElementById("motivoRevogar").value;
        if (!id) return;
        if (!confirm("Tem certeza absoluta? Isso n√£o pode ser desfeito.")) return;
        try {
          const signer = await getSigner();
          const contract = new Contract(contractAddress, abi, signer);
          const tx = await contract.revogarCertificado(id);
          notify("Revogando...", "loading");
          await tx.wait();
          notify("Certificado Revogado üö´", "success");
        } catch (e) { notify(e.reason || e.message, "error"); }
      }

      window.emitirDiploma = emitirDiploma;
      window.revogarDiploma = revogarDiploma;
    </script>
  </body>
</html>