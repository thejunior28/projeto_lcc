<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel do Emissor | Let's CoCreate</title>

    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #22d3ee;
        --dark: #000000;
        --card-bg: #111111;
        --border: #333333;
        --text: #f8fafc;
        --danger: #ef4444;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--dark);
        color: var(--text);
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .dashboard {
        background: var(--card-bg);
        width: 100%;
        max-width: 480px;
        padding: 35px;
        border-radius: 24px;
        box-shadow: 0 0 40px rgba(34, 211, 238, 0.1);
        border: 1px solid var(--border);
      }
      .brand {
        text-align: center;
        margin-bottom: 25px;
      }
      .brand-logo {
        width: 100px;
        height: auto;
        margin-bottom: 8px;
        border-radius: 12px;
      }
      .brand span {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 3px;
        color: #94a3b8;
        display: block;
        font-weight: 600;
      }

      /* √Årea da Carteira */
      .wallet-control {
        margin-bottom: 30px;
        display: flex;
        justify-content: center;
      }

      .input-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 13px;
        color: #cbd5e1;
      }
      input {
        width: 100%;
        padding: 12px;
        background: #000;
        border: 1px solid var(--border);
        color: white;
        border-radius: 10px;
        box-sizing: border-box;
        font-size: 14px;
        outline: none;
        transition: 0.3s;
      }
      input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);
      }
      .input-image input {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
      }
      .input-image input:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }
      button {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: black;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 800;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 10px;
      }
      button:hover {
        transform: translateY(-2px);
        filter: brightness(1.1);
        box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
      }
      .btn-link {
        display: block;
        text-align: center;
        margin-top: 20px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        text-decoration: none;
        font-size: 13px;
        transition: 0.3s;
        background: rgba(255, 255, 255, 0.03);
      }
      .btn-link:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .footer-note {
        margin-top: 25px;
        text-align: center;
        font-size: 11px;
        color: #475569;
      }
      .footer-note a {
        color: #64748b;
        text-decoration: none;
      }
      details {
        margin-top: 30px;
        border-top: 1px solid var(--border);
        padding-top: 15px;
      }
      summary {
        color: var(--danger);
        font-size: 12px;
        cursor: pointer;
        font-weight: bold;
        text-align: center;
        list-style: none;
      }
      .btn-revoke {
        background: transparent;
        border: 1px solid var(--danger);
        color: var(--danger);
        box-shadow: none;
        margin-top: 10px;
      }
      .btn-revoke:hover {
        background: var(--danger);
        color: white;
      }

      /* Mensagem de boas vindas quando desconectado */
      #welcomeMsg {
        text-align: center;
        color: #94a3b8;
        font-size: 14px;
        margin-top: 20px;
      }

      /* Ajuste do bot√£o Web3Modal */
      w3m-button {
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="brand">
        <img
          id="brandLogoImg"
          class="brand-logo"
          src=""
          alt=""
          crossorigin="anonymous"
        />
        <span> SciBound | Soulbound Tokens </span>
      </div>

      <div class="wallet-control">
        <w3m-button label="üîå Conectar Carteira" balance="show"></w3m-button>
      </div>

      <div id="welcomeMsg">üëÜ Conecte sua carteira para acessar o painel.</div>

      <div id="mainArea" style="display: none">
        <div class="input-group input-image">
          <label style="color: #60a5fa">üîó Link da Imagem do Certificado</label>
          <input
            type="text"
            id="ipfsImageInput"
            placeholder="Ex: https://gateway.pinata.cloud/ipfs/Qm..."
          />
        </div>

        <div class="input-group">
          <label>Nome do Aluno</label
          ><input type="text" id="nomeAluno" placeholder="Ex: Ana Silva" />
        </div>
        <div class="input-group">
          <label>Curso</label
          ><input
            type="text"
            id="nomeCurso"
            placeholder="Ex: Blockchain Specialist"
          />
        </div>
        <div class="input-group">
          <label>Data de Conclus√£o</label
          ><input
            type="text"
            id="dataColacao"
            placeholder="Ex: 18 de dezembro de 2025"
          />
        </div>
        <div class="input-group">
          <label>Carteira do aluno (0x...)</label
          ><input type="text" id="walletAluno" placeholder="Endere√ßo p√∫blico" />
        </div>
        <div class="input-group">
          <label>C√≥digo Valida√ß√£o</label
          ><input
            type="text"
            id="codigoValidacao"
            placeholder="Gerado ao emitir"
          />
        </div>

        <button onclick="emitirDiploma()">‚ú® Registrar na Blockchain</button>

        <details>
          <summary>‚ö†Ô∏è Op√ß√µes de Revoga√ß√£o</summary>
          <div style="margin-top: 10px">
            <input
              type="number"
              id="idRevogar"
              placeholder="ID do Token"
              style="margin-bottom: 5px"
            />
            <input type="text" id="motivoRevogar" placeholder="Motivo" />
            <button class="btn-revoke" onclick="revogarDiploma()">
              Revogar Permanentemente
            </button>
          </div>
        </details>
      </div>

      <a href="verificar.html" target="_blank" class="btn-link"
        >üîç Verificador de Certificados</a
      >

      <div class="footer-note">
        Tecnologia
        <a href="https://www.letscocreate.com.br/" target="_blank"
          >Let's CoCreate</a
        >
        (conforme Portaria MEC n¬∫ 70/2025).
      </div>
    </div>

    <script type="module">
      import {
        createWeb3Modal,
        defaultConfig,
      } from "https://esm.sh/@web3modal/ethers@4.0.1";
      import { BrowserProvider, Contract } from "https://esm.sh/ethers@6.11.1";

      // === 1. CONFIGURA√á√ïES GERAIS ===
      const LOGO_URL = "https://salmon-blank-anaconda-377.mypinata.cloud/ipfs/bafkreibzuryiyn54v4ji6gtfzo3grpz3rzgrwa5cqbysujssv5gp5q4gxi";
      
      // Endere√ßo do contrato na BASE SEPOLIA
      const contractAddress = "0x35670719542F0430cB8d9abbcE97fAc1FcfebE09";
      
      // Sua chave Pinata (Mantida conforme seu arquivo)
      const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIzMmQ0MjMzYS1iM2NiLTQ1OWYtOGJjOC1iYjYxOWNmMDIzNTgiLCJlbWFpbCI6InJpY2hhcmQuY2FzdHJvQHVuZXNwLmJyIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6IjkwNjUxOGRkMDAzODQ4N2IwNTRkIiwic2NvcGVkS2V5U2VjcmV0IjoiMjMwNDcyNDEwY2M2NjcyMzJmZDIwMTBlNmVjNjM5NmQxMDZkNGY0NGQ2YmE0ZjVmOTgyZDA1MTM0Y2JmM2U4OCIsImV4cCI6MTc5NjU5MDQ3OH0.2kF3Bzdn2x4qWRI0FClWgJh96ud2jzgkMsitCu6gZX0";
      
      const LINK_VERIFICADOR = "https://scibound.netlify.app/verificar.html"; // Ajuste se seu link for diferente

      const projectId = "ccaa314f20e97669bf6e926f17670656"; 

      const metadata = {
        name: "Emissor CoCreate",
        description: "Painel de Emiss√£o",
        url: window.location.origin,
        icons: [LOGO_URL],
      };

      // === 2. CONFIGURA√á√ÉO DA REDE BASE SEPOLIA ===
      const baseSepolia = {
        chainId: 84532, // ID da Base Testnet
        name: "Base Sepolia",
        currency: "ETH",
        explorerUrl: "https://sepolia.basescan.org",
        rpcUrl: "https://sepolia.base.org",
      };

      // Inicializa o Modal apenas com a Base Sepolia
      const modal = createWeb3Modal({
        ethersConfig: defaultConfig({ metadata }),
        chains: [baseSepolia], 
        projectId,
        enableAnalytics: true,
        themeVariables: {
          "--w3m-accent": "#22d3ee", // <--- MUDAMOS AQUI DE VOLTA PARA CIANO
          "--w3m-border-radius-master": "1px",
        },
      });

      // Configurar interface inicial
      document.getElementById("brandLogoImg").src = LOGO_URL;
      document.getElementById("codigoValidacao").value =
        "LCC-" + Math.random().toString(36).substr(2, 9).toUpperCase();


      // === 3. MONITORAR CONEX√ÉO ===
      modal.subscribeProvider(async ({ address, isConnected }) => {
        if (isConnected) {
          console.log("Conectado:", address);
          // Mostra o formul√°rio e esconde a msg de boas vindas
          document.getElementById("mainArea").style.display = "block";
          document.getElementById("welcomeMsg").style.display = "none";

          notify("‚úÖ Sistema Pronto para Emiss√£o", "success");
        } else {
          // Esconde formul√°rio, mostra msg de boas vindas
          document.getElementById("mainArea").style.display = "none";
          document.getElementById("welcomeMsg").style.display = "block";
        }
      });

      const abi = [
        "function emitirCertificado(address aluno, string memory uri) public",
        "function revogarCertificado(uint256 tokenId, string memory motivo) public",
      ];

      // === 4. FUN√á√ïES DE NEG√ìCIO ===
      async function getSigner() {
        const walletProvider = modal.getWalletProvider();
        if (!walletProvider)
          throw new Error("Carteira n√£o encontrada. Conecte novamente.");
        const provider = new BrowserProvider(walletProvider);
        const signer = await provider.getSigner();
        return signer;
      }

      function notify(msg, type) {
        Toastify({
          text: msg,
          duration: 4000,
          gravity: "top",
          position: "center",
          style: {
            background:
              type === "success"
                ? "#10B981"
                : type === "error"
                ? "#EF4444"
                : "#3B82F6",
            borderRadius: "10px",
          },
        }).showToast();
      }

      async function emitirDiploma() {
        const ipfsImage = document.getElementById("ipfsImageInput").value;
        const nome = document.getElementById("nomeAluno").value;
        const curso = document.getElementById("nomeCurso").value;
        const data = document.getElementById("dataColacao").value;
        const wallet = document.getElementById("walletAluno").value;
        const codigo = document.getElementById("codigoValidacao").value;

        if (!ipfsImage || !nome || !wallet)
          return notify("Preencha todos os campos obrigat√≥rios.", "error");

        notify("‚è≥ Criando metadados...", "loading");

        try {
          // A. Pega Signer
          const signer = await getSigner();
          const contract = new Contract(contractAddress, abi, signer);

          // B. Monta Metadados
          const metadata = {
            name: `Certificado Let's CoCreate - ${nome}`,
            description: "Certificado Soulbound Token.",
            image: ipfsImage,
            external_url: `${LINK_VERIFICADOR}?id=${codigo}`,
            attributes: [
              { trait_type: "Institui√ß√£o", value: "Let's CoCreate" },
              { trait_type: "Estudante", value: nome },
              { trait_type: "Curso", value: curso },
              { trait_type: "Data de Conclus√£o", value: data },
              { trait_type: "C√≥digo de Valida√ß√£o", value: codigo },
            ],
          };

          // C. Upload Pinata (Usando JWT direto para corrigir erro imediato)
          const res = await fetch(
            "https://api.pinata.cloud/pinning/pinJSONToIPFS",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${PINATA_JWT}`,
              },
              body: JSON.stringify({
                pinataContent: metadata,
                pinataMetadata: { name: `Cert_${codigo}.json` },
              }),
            }
          );
          
          if (!res.ok) throw new Error("Erro no Upload Pinata: " + res.statusText);

          const dataPinata = await res.json();
          const jsonUri = "ipfs://" + dataPinata.IpfsHash;

          // D. Transa√ß√£o
          notify("‚è≥ Aprove na sua Carteira...", "loading");
          const tx = await contract.emitirCertificado(wallet, jsonUri);

          notify("‚è≥ Confirmando no Bloco...", "loading");
          await tx.wait();

          notify(`üéâ Sucesso! Hash: ${tx.hash.slice(0, 6)}...`, "success");
          confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

          // Gera novo c√≥digo
          document.getElementById("codigoValidacao").value =
            "LCC-" + Math.random().toString(36).substr(2, 9).toUpperCase();
        } catch (e) {
          console.error(e);
          notify(e.reason || e.message || "Erro desconhecido", "error");
        }
      }

      async function revogarDiploma() {
        const id = document.getElementById("idRevogar").value;
        const motivo = document.getElementById("motivoRevogar").value;
        if (!id) return;
        if (!confirm("Confirmar Revoga√ß√£o?")) return;
        try {
          const signer = await getSigner();
          const contract = new Contract(contractAddress, abi, signer);

          const tx = await contract.revogarCertificado(id, motivo);
          notify("Revogando...", "loading");
          await tx.wait();
          notify("Token Queimado üî•", "success");
        } catch (e) {
          notify(e.message, "error");
        }
      }

      // === 5. EXPOR FUN√á√ïES PARA O HTML ===
      window.emitirDiploma = emitirDiploma;
      window.revogarDiploma = revogarDiploma;
    </script>
  </body>
</html>